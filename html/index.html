<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Editor</title>
  <link href="./../styles/reset.css" rel="stylesheet" type="text/css" />
  <link href="./../styles/editor.css" rel="stylesheet" type="text/css" />
  <style>
    body {
      /* background: green; */
    }
    p {
      font-size: 24px;
      letter-spacing: 2px;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
</head>
<body>
  <div id="editor">
    <div>
      <button id="b">두껍게</button>
      <button id="em">기울기</button>
      <button id="h2">제목</button>
      <button id="h3">중제목</button>
      <button id="h4">소제목</button>
      <button id="pre">코드</button>
    </div>
    <!-- <div id="edit-field" contentEditable><p><b>222<em>333333</em>222</b></p><p><b>222<em>333333</em>222</b></p></div> -->
    <div id="edit-field" contentEditable><p>1111<b>2222</b>3333</p></div>
    <!-- <div id="edit-field" contentEditable><p><br></p></div> -->
    <div id="edit-field2"></div>
  </div>
  <script src="./../script/editor.js" ></script>
  <script>
    var editor = new Editor('#editor');

    function test() {
      const selection = document.getSelection()
      const range = selection.getRangeAt(0)
      const rangeStringSplit = selection.toString().split('\n').filter((d) => d !== '')
      const rangeStringSplitLen = rangeStringSplit.length
      let {
        anchorNode, // 시작 노드
        anchorOffset, // 시작 점
        focusNode, // 끝 노드
        focusOffset // 끝 점
      } = selection
      let startNode = anchorNode
      let startOffset = anchorOffset
      let endNode = focusNode
      let endOffset = focusOffset

      const editField = document.getElementById('edit-field');

      let lines = [] // 라인 Object
      let lineWithStartNode = null
      let lineWithEndNode = null
      let lineWithStartNodeIndex = -1
      let lineWithEndNodeIndex = -1

      lineWithStartNode = _getLineWithNodeFn(startNode, editField)
      lineWithEndNode = _getLineWithNodeFn(endNode, editField)

      let editFieldChildren = Array.from(editField.children)
      lineWithStartNodeIndex = editFieldChildren.findIndex((child) => child === lineWithStartNode)
      lineWithEndNodeIndex = editFieldChildren.findIndex((child) => child === lineWithEndNode)

      if (lineWithEndNodeIndex < lineWithStartNodeIndex) {
        let tmp = null; 
        tmp = lineWithStartNode; lineWithStartNode = lineWithEndNode; lineWithEndNode = tmp
        tmp = lineWithStartNodeIndex; lineWithStartNodeIndex = lineWithEndNodeIndex; lineWithEndNodeIndex = tmp
        tmp = startNode; startNode = endNode; endNode = tmp
        tmp = startOffset; startOffset = endOffset; endOffset = tmp;
      }

      let elementWithStartNode = null // 라인 DOM 바로 하위 자식(출발을 포함한)
      let elementWithEndNode = null // 라인 DOM 바로 하위 자식(끝을 포함한)

      let lineElement
      let type
      let rangeString
      let isLast
      let lineObj
      for (let i = 0; i < rangeStringSplitLen; i++) {
        rangeString = rangeStringSplit[i]

        // 한줄일 경우
        if (rangeStringSplitLen - 1 === 0) {
          lineElement = lineWithStartNode
          type = selection.type
        } 
        // Range 가 다수의 줄로 구성되어 있을 경우
        else {
          isLast = false
          type = 'Range'

          // 첫 번째 줄일 경우
          if (i === 0) {
            lineElement = lineWithStartNode

            let endObj = _getEndObjFn(lineElement)
            endNode = endObj.endNode
            endOffset = endObj.endOffset
          }
          // 마지막 줄일 경우
          else if (i === rangeStringSplitLen - 1) {
            lineElement = lineWithEndNode

            let startObj = _getStartObjFn(lineElement)
            startNode = endObj.startNode
            startOffset = endObj.startOffset

          } 
          // 중간 줄일 경우
          else {
            lineElement = lineElement.nextElementSibling

            let startObj = _getStartObjFn(lineElement)
            startNode = endObj.startNode
            startOffset = endObj.startOffset

            let endObj = _getEndObjFn(lineElement)
            endNode = endObj.endNode
            endOffset = endObj.endOffset
          }
        }

        lines.push({
          lineElement,
          type,
          rangeString,
          isLast,

          startNode,
          startOffset,
          endNode,
          endOffset,
        })
      }

      return {
        lines
      }
    }
  </script>
</body>
</html>