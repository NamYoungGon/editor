<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Editor</title>
  <link href="./../styles/reset.css" rel="stylesheet" type="text/css" />
  <link href="./../styles/editor.css" rel="stylesheet" type="text/css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
</head>
<body>
  <div id="editor">
    <div>
      <button id="b">두껍게</button>
      <button id="h2">제목</button>
      <button id="h3">중제목</button>
      <button id="h4">소제목</button>
      <button id="pre">코드</button>
    </div>
    <div id="edit-field" contentEditable></div>
  </div>
  <script src="./../script/editor.js" ></script>
  <script>
    var editor = new Editor('#editor');


    function test() {
      const selection = document.getSelection()
      const range = selection.getRangeAt(0)
      const rangeString = selection.toString()
      const rangeStringSplit = rangeString.split('\n').filter((d) => d !== '')
      const rangeStringSplitLen = rangeStringSplit.length
      let {
        type, // Caret, Range
        anchorNode, // 시작 노드
        anchorOffset, // 시작 점
        focusNode, // 끝 노드
        focusOffset // 끝 점
      } = selection
      let startNode = anchorNode
      let startOffset = anchorOffset
      let endNode = focusNode
      let endOffset = focusOffset

      const editField = document.getElementById('edit-field');

      let lineArr = [] // 라인 Object
      let lineWithStartNode = null
      let lineWithEndNode = null
      let lineWithStartNodeIndex = -1
      let lineWithEndNodeIndex = -1

      const getLineWithNodeFn = (node) => {
        let tmpParentElement = node
        let lineWithNode = null
        for (;;) {
          if (tmpParentElement.parentNode === editField) {
            lineWithNode = tmpParentElement
            break
          }

          tmpParentElement = tmpParentElement.parentNode
        }

        return lineWithNode
      }

      lineWithStartNode = getLineWithNodeFn(startNode)
      lineWithEndNode = getLineWithNodeFn(endNode)

      let editFieldChildren = Array.from(editField.children)
      lineWithStartNodeIndex = editFieldChildren.findIndex((child) => child === lineWithStartNode)
      lineWithEndNodeIndex = editFieldChildren.findIndex((child) => child === lineWithEndNode)

      if (lineWithEndNodeIndex < lineWithStartNodeIndex) {
        let tmp = null
        tmp = lineWithStartNode
        lineWithStartNode = lineWithEndNode
        lineWithEndNode = tmp

        tmp = lineWithStartNodeIndex
        lineWithStartNodeIndex = lineWithEndNodeIndex
        lineWithEndNodeIndex = tmp

        tmp = startNode
        startNode = endNode
        endNode = tmp

        tmp = startOffset
        startOffset = endOffset
        endOffset = tmp
      }

      let elementWithStartNode = null // 라인 DOM 바로 하위 자식(출발을 포함한)
      let elementWithEndNode = null // 라인 DOM 바로 하위 자식(끝을 포함한)

      const getEndObjFn = (lineElement) => {
        let endNode
        let endOffset
        let { childNodes } = lineElement

        const _textChild = (childNodes) => {
          const childNodesLen = childNodes.length

          for (let i = childNodesLen - 1; i >= 0; i--) {
            let childNode = childNodes[i]
        debugger;
            if (childNode.tagName === undefined && childNode.textContent !== '') {
              endNode = childNode
              endOffset = childNode.textContent.length
              return true
            } else {
              let result = _textChild(childNode.childNodes)
              if (result === true)
                break
            }
          }
        }

        _textChild(childNodes)

        return {
          endNode,
          endOffset,
        }
      }

      const getStartObjFn = (lineElement) => {
        let startNode
        let { childNodes } = lineElement

        const _textChild = (childNodes) => {
          const childNodesLen = childNodes.length

          for (let i = 0; i < childNodesLen; i++) {
            let childNode = childNodes[i]
        
            if (childNode.tagName === undefined && childNode.textContent !== '') {
              startNode = childNode
              return true
            } else {
              let result = _textChild(childNode.childNodes)
              if (result === true)
                break
            }
          }
        }

        _textChild(childNodes)

        return {
          startNode,
          startOffset: 0,
        }
      }

      let lineElement
      for (let i = 0; i < rangeStringSplitLen; i++) {
        let lineObj

        // 한줄일 경우
        if (rangeStringSplitLen - 1 === 0) {
          lineElement = lineWithStartNode

          lineObj = {
            lineElement,
            startNode,
            startOffset,
            endNode,
            endOffset,
          }
        } 
        // Range 가 다수의 줄로 구성되어 있을 경우
        else {
          // 첫 번째 줄일 경우
          if (i === 0) {
            lineElement = lineWithStartNode

            const { endNode, endOffset } = getEndObjFn(lineElement)

            lineObj = {
              lineElement,
              startNode,
              startOffset,
              endNode,
              endOffset,
            }
          }
          // 마지막 줄일 경우
          else if (i === rangeStringSplitLen - 1) {
            lineElement = lineWithEndNode

            let { startNode, startOffset } = getStartObjFn(lineElement)

            lineObj = {
              lineElement,
              startNode,
              startOffset,
              endNode,
              endOffset,
            }
          } 
          // 중간 줄일 경우
          else {
            lineElement = lineElement.nextElementSibling
            let { startNode, startOffset } = getStartObjFn(lineElement)
            const { endNode, endOffset } = getEndObjFn(lineElement)

            lineObj = {
              lineElement,
              startNode,
              startOffset,
              endNode,
              endOffset,
            }
          }
        }

        lineArr.push(lineObj)
      }

      return ;

      let tmp = startCaret
      startCaret = startCaret > endCaret ? endCaret : startCaret
      endCaret = tmp > endCaret ? tmp : endCaret

      let result = {
        type,
        range,
        selection,
/*
        startNode,
        startOffset,
        elementWithStartNode,
        endOffset,
        elementWithEndNode,
        startCaret,
        endCaret,
*/
        rangeString,
        lineElement,
        // isLast: lineElement.textContent.length === (startCaret > endCaret ? startCaret : endCaret),
        // lineTextLength: lineElement.textContent.length
      }

      return result
    }
  </script>
</body>
</html>